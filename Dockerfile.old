FROM node:20-alpine AS base

# Install basic dependencies
RUN apk add --no-cache \
    bash \
    curl \
    jq \
    coreutils

# Set working directory
WORKDIR /app

# Copy verification script
COPY verify-installation.sh ./

# Install Cardano tools using the verification script
# Note: This works best on x86_64 Linux. On ARM64 (Apple Silicon),
# you may need to use Docker with --platform linux/amd64 or build from source
RUN chmod +x verify-installation.sh && \
    # Detect architecture and warn if not x86_64
    ARCH=$(uname -m) && \
    if [ "$ARCH" != "x86_64" ]; then \
    echo "WARNING: Detected $ARCH architecture."; \
    echo "Pre-built Cardano binaries may not be available for $ARCH."; \
    echo "Consider running: docker build --platform linux/amd64 ..."; \
    fi && \
    # Run non-interactively (auto-install)
    yes | ./verify-installation.sh || true && \
    # Add bin to PATH permanently
    if [ -d "./bin" ]; then \
    cp -r ./bin/* /usr/local/bin/ 2>/dev/null || true; \
    fi

# Final application stage
FROM base AS app 

# Copy package files
COPY package*.json ./

# Install Node.js dependencies
RUN npm ci --only=production && \
    npm cache clean --force

# Copy application files
COPY index.js index.d.ts convert.sh ./
COPY docs/ ./docs/

# Make scripts executable
RUN chmod +x index.js convert.sh

# Create output directory
RUN mkdir -p /output

# Set environment variables
ENV NODE_ENV=production \
    CARDANO_NETWORK=mainnet \
    OUTPUT_DIR=/output \
    NON_INTERACTIVE=1

# Volume for output files
VOLUME ["/output"]

# Security: Run as non-root user
RUN addgroup -S cardano && \
    adduser -S -G cardano cardano && \
    chown -R cardano:cardano /app /output

USER cardano

# Default command shows help
CMD ["node", "index.js", "--help"]
